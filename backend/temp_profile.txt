import React, { useState, useEffect, useRef } from 'react';
import { useNavigate } from 'react-router-dom';
import './ProfilePage.css';
import safeLocalStorage from '../utils/safeStorage';
import authService from '../services/authService';
import uploadService from '../services/uploadService';
import { toast } from 'react-hot-toast';
import BackgroundSelector from '../components/BackgroundSelector';
import { t, getLanguage, setLanguage } from '../i18n';

function ProfilePage({ viewUser = null }) {
  const [user, setUser] = useState(null);
  const [loading, setLoading] = useState(true);
  const [showSettings, setShowSettings] = useState(false);
  const [darkMode, setDarkMode] = useState(false);
  const [activeTab, setActiveTab] = useState('posts');
  const [langState, setLangState] = useState(getLanguage());
  const navigate = useNavigate();
  const [uploading, setUploading] = useState(false);
  const fileRef = useRef(null);
  const scrollRef = useRef(null);

  useEffect(() => {
    const load = async () => {
      setLoading(true);
      try {
        if (viewUser) setUser(viewUser);
        else {
          const current = await authService.getCurrentUser();
          if (current) setUser(current);
          else
            setUser({
              id: 'local-' + Date.now(),
              idNumber: 'FWP' + Math.random().toString(36).slice(2, 10).toUpperCase(),
              name: 'Your Name',
              bio: 'Write a short bio...',
              profilePic: '',
              profileBackground: '/backgrounds/bg1.svg',
              stats: { followers: 125, following: 89, posts: 34 },
              wallet: { goldCoins: 2500 },
            });
        }
      } catch (err) {
        console.error(err);
        toast.error('Failed to load user');
      } finally {
        setLoading(false);
      }
    };
    load();
  }, [viewUser]);

  useEffect(() => {
    const isDark = safeLocalStorage.getItem('darkMode') === 'true';
    setDarkMode(isDark);
    if (isDark) document.body.classList.add('dark-mode');
  }, []);

  const toggleDarkMode = () => {
    const n = !darkMode;
    setDarkMode(n);
    safeLocalStorage.setItem('darkMode', n ? 'true' : 'false');
    if (n) document.body.classList.add('dark-mode');
    else document.body.classList.remove('dark-mode');
  };

  const handleUpdateProfile = async (updatedFields) => {
    if (!user) return;
    try {
      const payload = { ...user, ...updatedFields };
      const res = await authService.updateProfile(payload);
      setUser(res);
      toast.success('Profile updated');
    } catch (err) {
      console.error(err);
      toast.error('Update failed');
    }
  };

  const handleProfilePicChange = async (e) => {
    const file = e.target.files?.[0];
    if (!file) return;
    try {
      setUploading(true);
      const url = await uploadService.uploadImage(file);
      await handleUpdateProfile({ profilePic: url });
    } catch (err) {
      console.error(err);
      toast.error('Upload failed');
    } finally {
      setUploading(false);
    }
  };

  const handleSetBackground = async (url) => {
    await handleUpdateProfile({ profileBackground: url });
  };

  const handleLogout = () => {
    authService.logout();
    navigate('/login');
    toast.success('Logged out');
  };

  const changeLanguage = (lang) => {
    setLanguage(lang);
    setLangState(lang);
    // re-render happens via state; other components should call t() when rendering
  };

  if (loading) return <div className="profile-page"><div className="loading">{t('loading')}</div></div>;
  if (!user) return <div className="profile-page"><div className="error">{t('noProfile')}</div></div>;

  const backgroundStyle = user.profileBackground ? { backgroundImage: `url(${user.profileBackground})` } : {};

  return (
    <div className="profile-page" ref={scrollRef} style={{ ...backgroundStyle }}>
      <header className="profile-header">
        <div className="header-left">
          <button className="btn-back" onClick={() => navigate(-1)}>â†</button>
        </div>
        <div className="header-center">
          <h1 className="header-title">{t('profile.title')}</h1>
        </div>
        <div className="header-right">
          <button className="btn-settings btn-settings--large" onClick={() => setShowSettings(true)} title={t('settings.title')}>
            <span className="gear">âš™ï¸</span>
            <span className="settings-label">{t('settings.title')}</span>
          </button>
        </div>
      </header>

      <div className="profile-container">
        <section className="profile-pic-section">
          <div className="profile-pic-border">
            <img className="profile-pic" src={user.profilePic || '/backgrounds/bg1.svg'} alt="profile" />
          </div>
          <button className="btn-change-photo" onClick={() => fileRef.current?.click()} disabled={uploading}>{uploading ? 'â€¦' : t('btn.changePhoto')}</button>
          <input ref={fileRef} type="file" accept="image/*" style={{ display: 'none' }} onChange={handleProfilePicChange} />
        </section>

        <section className="profile-info-block">
          <h2 className="profile-name">{user.name}</h2>
          <div className="profile-id">@{user.idNumber}</div>
          <p className="profile-bio">{user.bio}</p>
        </section>

        <div className="stats-block">
          <div className="stat-item" onClick={() => setActiveTab('followers')}>
            <div className="stat-number">{user.stats?.followers || 0}</div>
            <div className="stat-label">Followers</div>
          </div>
          <div className="stat-item" onClick={() => setActiveTab('following')}>
            <div className="stat-number">{user.stats?.following || 0}</div>
            <div className="stat-label">Following</div>
          </div>
          <div className="stat-item" onClick={() => setActiveTab('posts')}>
            <div className="stat-number">{user.stats?.posts || 0}</div>
            <div className="stat-label">Posts</div>
          </div>
        </div>

        <div className="earnings-card">
          <div>
            <div className="earnings-title">Earnings</div>
            <div className="earnings-amount">{user.wallet?.goldCoins || 0} ðŸª™</div>
          </div>
          <div className="earnings-buttons">
            <button className="btn-earnings">Top-up</button>
            <button className="btn-earnings">Withdraw</button>
          </div>
        </div>

        <div className="profile-tabs">
          <button className={`tab-btn ${activeTab==='posts'?'active':''}`} onClick={() => setActiveTab('posts')}>Posts</button>
          <button className={`tab-btn ${activeTab==='media'?'active':''}`} onClick={() => setActiveTab('media')}>Media</button>
          <button className={`tab-btn ${activeTab==='likes'?'active':''}`} onClick={() => setActiveTab('likes')}>Likes</button>
        </div>

        <div className="tab-content">
          {activeTab==='posts' && <div className="empty-state">No posts yet</div>}
          {activeTab==='media' && <div className="empty-state">No media yet</div>}
          {activeTab==='likes' && <div className="empty-state">No liked posts</div>}
        </div>
      </div>

      <aside className={`settings-drawer ${showSettings ? 'open' : ''}`}>
        <div className="drawer-header">
          <h2>{t('settings.title')}</h2>
          <button className="btn-close" onClick={() => setShowSettings(false)}>âœ–</button>
        </div>
        <div className="drawer-content">
          <div className="settings-section">
            <div className="section-title">{t('settings.appearance')}</div>
            <div className="setting-item">
              <div className="setting-label">{t('settings.darkMode')}</div>
              <button className={`toggle-switch ${darkMode?'on':''}`} onClick={toggleDarkMode}>
                <div className="toggle-knob" />
              </button>
            </div>

            <div className="setting-item">
              <div className="setting-label">{t('settings.profileBackground')}</div>
            </div>
            <div style={{ padding: 12 }}>
              <BackgroundSelector current={user.profileBackground} onSelect={handleSetBackground} onUpload={async (file) => { const url = await uploadService.uploadImage(file); await handleSetBackground(url); }} />
            </div>

            <div className="setting-item">
              <div className="setting-label">{t('settings.language')}</div>
              <div style={{ display: 'flex', gap: 8, marginTop: 8 }}>
                <button className={`lang-btn ${langState==='en'?'active':''}`} onClick={() => changeLanguage('en')}>{t('settings.language.en')}</button>
                <button className={`lang-btn ${langState==='bn'?'active':''}`} onClick={() => changeLanguage('bn')}>{t('settings.language.bn')}</button>
              </div>
            </div>
          </div>

          <div className="settings-section">
            <div className="section-title">Account</div>
            <button className="setting-item" onClick={() => navigate('/change-email')}>Change Email</button>
            <button className="setting-item" onClick={() => navigate('/change-password')}>Change Password</button>
            <button className="setting-item logout" onClick={handleLogout}>{t('profile.logout')}</button>
          </div>
        </div>
      </aside>

      {showSettings && <div className="drawer-overlay" onClick={() => setShowSettings(false)} />}
    </div>
  );
}

export default ProfilePage;
